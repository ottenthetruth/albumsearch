<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="general.css">
    <link rel="stylesheet" href="searchforalbums.css">
    <title>Search for Albums!</title>
</head>

<body>
  <div class="myheader">
      <div class="banner">
          <h1 id="bannerText">YOUR WEBSITE BANNER</h1>
          <div class="nav-container">
              <a class="imherebutton">Search for Albums!</a>
              <a href="page2.html" class="page-button">My Profile</a>
              <a href="page3.html" class="page-button">Featured</a>
              <a href="page4.html" class="page-button">Page 4</a>
              <a href="page5.html" class="page-button">About RYM</a>
          </div>
      </div>
  </div>

<div class="parent">
    <div class="div1">
      <div class="search-bar">
            <input type="text" id="mysearch" class="search-input"  placeholder="Start Searching here!">
            <a onclick="getAlbums()" class="search-button">Search!</a>
      </div>
    </div>
    <div class="album-card">
        <img class="album-cover" src="" alt="Album Cover">
        <h2 class="album-name"></h2>
        <p class="album-artist"></p>
    </div>
</div>

<script>
    getAlbums();

async function getAccessToken() {
    const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get("code");
    if (code) {
        const tokenEndpoint = "https://accounts.spotify.com/api/token";
        const client_secret = "2d5a82decbc240e4adadcbd86f342321"; // Replace with your actual client secret
        const redirect_uri = "https://ottenthetruth.github.io/https://ottenthetruth.github.io/albumsearch/searchforalbums.html"; // Make sure this matches your Spotify App's redirect URI
        const basicAuthHeader = btoa(`e9fec6e1cb5241e0a41ab98db146bc3c:${client_secret}`);

        const data = {
            grant_type: "authorization_code",
            code: code,
            redirect_uri: redirect_uri,
        };

        const response = await fetch(tokenEndpoint, {
            method: "POST",
            headers: {
                "Authorization": `Basic ${basicAuthHeader}`,
                "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            },
            body: new URLSearchParams(data),
        });

        if (response.status === 200) {
            const tokenData = await response.json();
            const accessToken = tokenData.access_token;

            localStorage.setItem("access_token", accessToken);

            return tokenData.access_token;
        } else {
          return localStorage.getItem("access_token");
        }
    } /* end if(code) */

} /* end getAccessToken */
    function authorizeSpotify() {
        const clientID = "e9fec6e1cb5241e0a41ab98db146bc3c";
        const redirectURI = "https://ottenthetruth.github.io/albumsearch/searchforalbums.html";
        const spotifyAuthURL = `https://accounts.spotify.com/authorize?client_id=${clientID}&response_type=code&redirect_uri=${redirectURI}&scope=user-library-read%20playlist-read-private`;
        window.location.href = spotifyAuthURL;
    }

async function getAlbums() {
        const resultsList = document.createElement('ul');
          authorizeSpotify();
          const accessToken = await getAccessToken();
          if(accessToken) {
              var searchBar = document.getElementById("mysearch");
            const searchQuery = searchBar.value;
            const response = await fetch(`https://api.spotify.com/v1/search?q=album:${searchQuery}&type=album&limit=5`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                    },
                });
                if(response.status === 200) {
                    const data = await response.json();
                    const albums = data.albums.items;
                    albums.forEach(albums => {
                        const listItem = document.createElement('li');
                        const albumCard = document.querySelector('.albumcard').cloneNode(true);
                        albumCard.querySelector('.album-name').textContent = album.name;
                        albumCard.querySelector('.album-artist').textContent = album.artists[0].name; // Assuming the first artist is displayed
                        albumCard.querySelector('.album-cover').src = album.images[0].url; // Assuming you want the first image (200x200px)
                        listItem.appendChild(albumCard);
                        resultsList.appendChild(listItem);
                    });
                } else {
                        document.getElementById("mysearch").value = "Error";
                }


          } /*end if access token*/

} /* end getAlbums*/
</script>

</body>
</html>

